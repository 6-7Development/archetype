name: Railway PR Preview Deploy

# Trigger on PR lifecycle events
on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  # Deploy preview environment
  deploy-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    # Skip deployment on PR close - cleanup job handles it
    if: github.event.action != 'closed'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test || echo "No tests configured yet"
        continue-on-error: true

      - name: Deploy to Railway Preview
        uses: ayungavis/railway-preview-deploy@v1
        id: railway
        with:
          railway_token: ${{ secrets.RAILWAY_API_TOKEN }}
          railway_project_id: ${{ secrets.RAILWAY_PROJECT_ID }}
        env:
          # Pass through environment variables for preview
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ secrets.GITHUB_REPO }}
          GITHUB_BRANCH: ${{ secrets.GITHUB_BRANCH }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          # Enable PR workflow for preview environments
          ENABLE_PR_WORKFLOW: 'true'

      - name: Wait for deployment
        run: |
          echo "Waiting 30s for Railway deployment to stabilize..."
          sleep 30

      - name: Health check
        id: health
        run: |
          PREVIEW_URL="${{ steps.railway.outputs.url }}"
          echo "Testing preview URL: $PREVIEW_URL"
          
          # Retry health check up to 5 times
          for i in {1..5}; do
            if curl -f -s "$PREVIEW_URL/api/health" > /dev/null; then
              echo "âœ… Health check passed"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ Attempt $i/5 failed, retrying in 10s..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 5 attempts"
          echo "health_status=unhealthy" >> $GITHUB_OUTPUT
          exit 1

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.railway.outputs.url }}';
            const prNumber = context.issue.number;
            const commitSha = context.sha.substring(0, 7);
            
            const comment = `## ðŸš€ Preview Deployment Ready
            
            **Preview URL:** ${previewUrl}
            **Commit:** \`${commitSha}\`
            **Status:** âœ… Healthy
            
            ### Quick Links
            - ðŸŒ [Open Preview](${previewUrl})
            - ðŸ” [View Logs](${previewUrl}/api/health)
            - ðŸ“Š [Railway Dashboard](https://railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }})
            
            > This preview environment will be automatically destroyed when the PR is closed.`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on health check failure
        uses: actions/github-script@v7
        if: failure() && steps.health.outputs.health_status == 'unhealthy'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.railway.outputs.url }}';
            const prNumber = context.issue.number;
            
            const comment = `## âš ï¸ Preview Deployment Warning
            
            **Preview URL:** ${previewUrl}
            **Status:** âŒ Health check failed
            
            The deployment completed but the health check endpoint is not responding.
            This might indicate a startup issue. Check the Railway logs for details.
            
            [View Railway Logs](https://railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }})`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Cleanup preview when PR closes
  cleanup-preview:
    name: Cleanup PR Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Remove Railway preview
        uses: ayungavis/railway-preview-deploy@v1
        with:
          railway_token: ${{ secrets.RAILWAY_API_TOKEN }}
          railway_project_id: ${{ secrets.RAILWAY_PROJECT_ID }}
          cleanup: true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            
            const comment = `## ðŸ§¹ Preview Environment Cleaned Up
            
            The preview deployment for this PR has been destroyed.`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# Required secrets to configure in GitHub repository:
# - RAILWAY_API_TOKEN: Get from Railway dashboard -> Account Settings -> Tokens
# - RAILWAY_PROJECT_ID: Get from Railway project -> Settings -> General
# - DATABASE_URL: PostgreSQL connection string (Railway will provide preview database)
# - ANTHROPIC_API_KEY: Anthropic API key for AI features
# - GITHUB_TOKEN: Automatically provided by GitHub Actions
# - GITHUB_REPO: Format "username/repo-name"
# - GITHUB_BRANCH: Usually "main"
# - SESSION_SECRET: Random secret for session encryption
